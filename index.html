<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Entra x RI Federation Sandbox - Quick Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-50 text-gray-800 antialiased">
    <header class="bg-sky-700 text-white shadow">
      <div class="max-w-7xl mx-auto px-4 py-6 flex items-center justify-between">
        <h1 class="text-2xl font-semibold tracking-wide">Entra x RI Federation Sandbox</h1>
        <nav class="hidden md:flex space-x-6 text-sm font-medium">
          <a href="#overview" class="hover:underline">Overview</a>
          <a href="#quickform" class="hover:underline">Prefill</a>
          <a href="#tenant" class="hover:underline">Azure Tenant</a>
          <a href="#domain" class="hover:underline">Custom Domain</a>
          <a href="#ri" class="hover:underline">RI Setup</a>
          <a href="#federate" class="hover:underline">Federate</a>
          <a href="#users" class="hover:underline">Pilot Users</a>
          <a href="#test" class="hover:underline">Test</a>
          <a href="#rollback" class="hover:underline">Rollback</a>
        </nav>
      </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-10 space-y-16">
      <section id="overview" class="space-y-4">
        <h2 class="text-xl font-semibold text-sky-700">0. Overview</h2>
        <p>Goal: set up an Entra sandbox that federates a test domain to RI using the RI Azure.json partner. Keep template defaults. Only adjust tenant specific values. Use idautoID as ImmutableID. Create users in RI first, then create them in Entra with the same anchor.</p>
        <p class="text-sm">RI paths: Identity Providers is at Configuration > Security > Identity Providers. Federated Partners is at Configuration > Security > Federated Partners.</p>
        <div class="rounded border-l-4 border-amber-400 bg-amber-50 p-3 text-sm">
          You need a test domain. Buy one on GoDaddy. It can be a few dollars per year. Do not federate the onmicrosoft domain.
        </div>
      </section>

      <section id="quickform" class="space-y-4">
        <h2 class="text-xl font-semibold text-sky-700">1. Prefill values</h2>

        <div class="rounded-lg border bg-white">
          <div class="flex border-b">
            <button id="tab-vars" class="px-4 py-2 text-sm font-semibold text-sky-700 border-b-2 border-sky-700">Tenant and domain</button>
            <button id="tab-user" class="px-4 py-2 text-sm">User builder</button>
          </div>

          <div id="panel-vars" class="p-4 grid md:grid-cols-2 gap-4">
            <div class="relative group">
              <label class="block text-sm font-medium mb-1 flex items-center gap-2">
                Tenant ID
                <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-sky-700 text-white text-xs">?</span>
                <span class="absolute left-0 top-7 z-10 hidden group-hover:block bg-white border rounded p-2 text-xs w-80 shadow">
                  From Microsoft. Entra admin center. Identity > Overview shows Tenant ID. If you already had a default tenant, use that. You do not need to create a new tenant.
                </span>
              </label>
              <input id="TENANT_ID" class="w-full border rounded p-2" placeholder="00000000-0000-0000-0000-000000000000"/>
            </div>

            <div class="relative group">
              <label class="block text-sm font-medium mb-1 flex items-center gap-2">
                Custom domain to federate
                <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-sky-700 text-white text-xs">?</span>
                <span class="absolute left-0 top-7 z-10 hidden group-hover:block bg-white border rounded p-2 text-xs w-80 shadow">
                  Your test domain, for example examplelab.com. You will add a TXT record in DNS to verify it in Entra.
                </span>
              </label>
              <input id="DOMAIN" class="w-full border rounded p-2" placeholder="examplelab.com"/>
            </div>

            <div class="md:col-span-2 relative group">
              <label class="block text-sm font-medium mb-1 flex items-center gap-2">
                RI host base URL
                <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-sky-700 text-white text-xs">?</span>
                <span class="absolute left-0 top-7 z-10 hidden group-hover:block bg-white border rounded p-2 text-xs w-80 shadow">
                  Your RI tenant base URL. Example https://yourtenant.us004-rapididentity.com
                </span>
              </label>
              <input id="RI_HOST" class="w-full border rounded p-2" placeholder="https://your-ri-host"/>
            </div>

            <div class="md:col-span-2 relative group">
              <label class="block text-sm font-medium mb-1 flex items-center gap-2">
                RI IdP signing cert (PEM)
                <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-sky-700 text-white text-xs">?</span>
                <span class="absolute left-0 top-7 z-10 hidden group-hover:block bg-white border rounded p-2 text-xs w-80 shadow">
                  In RI go to Configuration > Security > Identity Providers > RapidIdentity. Download the PEM certificate and paste here including the begin and end lines.
                </span>
              </label>
              <textarea id="PEM" class="w-full border rounded p-2 h-28" placeholder="-----BEGIN CERTIFICATE-----"></textarea>
            </div>

            <div class="md:col-span-2">
              <button id="applyVars" class="px-4 py-2 bg-sky-700 text-white rounded">Apply</button>
            </div>
          </div>

          <div id="panel-user" class="p-4 hidden space-y-4">
            <div class="relative group">
              <label class="block text-sm font-medium mb-1 flex items-center gap-2">
                RI user JSON
                <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-sky-700 text-white text-xs">?</span>
                <span class="absolute left-0 top-7 z-10 hidden group-hover:block bg-white border rounded p-2 text-xs w-80 shadow">
                  Paste a raw RI user object. This will fill UPN from mail and the anchor from idautoID.
                </span>
              </label>
              <textarea id="RI_JSON" class="w-full border rounded p-2 h-40" placeholder='{"mail":"testuser@examplelab.com","idautoID":"aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"}'></textarea>
            </div>

            <div class="grid md:grid-cols-2 gap-4">
              <div class="relative group">
                <label class="block text-sm font-medium mb-1 flex items-center gap-2">
                  User UPN
                  <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-sky-700 text-white text-xs">?</span>
                  <span class="absolute left-0 top-7 z-10 hidden group-hover:block bg-white border rounded p-2 text-xs w-80 shadow">
                    Email for the federated domain. Example testuser@examplelab.com
                  </span>
                </label>
                <input id="UPN" class="w-full border rounded p-2" placeholder="testuser@examplelab.com"/>
              </div>

              <div class="relative group">
                <label class="block text-sm font-medium mb-1 flex items-center gap-2">
                  Mail nickname
                  <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-sky-700 text-white text-xs">?</span>
                  <span class="absolute left-0 top-7 z-10 hidden group-hover:block bg-white border rounded p-2 text-xs w-80 shadow">
                    Alias without domain. Example testuser
                  </span>
                </label>
                <input id="NICK" class="w-full border rounded p-2" placeholder="testuser"/>
              </div>

              <div class="relative group">
                <label class="block text-sm font-medium mb-1 flex items-center gap-2">
                  Temp password
                  <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-sky-700 text-white text-xs">?</span>
                  <span class="absolute left-0 top-7 z-10 hidden group-hover:block bg-white border rounded p-2 text-xs w-80 shadow">
                    Any lab password you will change later
                  </span>
                </label>
                <input id="PWD" class="w-full border rounded p-2" value="P@ssw0rd123!"/>
              </div>

              <div class="relative group">
                <label class="block text-sm font-medium mb-1 flex items-center gap-2">
                  ImmutableID
                  <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-sky-700 text-white text-xs">?</span>
                  <span class="absolute left-0 top-7 z-10 hidden group-hover:block bg-white border rounded p-2 text-xs w-80 shadow">
                    Auto filled from RI user JSON idautoID. If not using JSON, paste the idautoID from RI.
                  </span>
                </label>
                <input id="ANCHOR" class="w-full border rounded p-2" placeholder="aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"/>
              </div>
            </div>

            <button id="applyUser" class="px-4 py-2 bg-sky-700 text-white rounded">Apply</button>
          </div>
        </div>
      </section>

      <section id="tenant" class="space-y-4">
        <h2 class="text-xl font-semibold text-sky-700">2. Azure tenant</h2>
        <ol class="list-decimal list-inside space-y-2">
          <li>Go to https://portal.azure.com and sign in</li>
          <li>If a default tenant exists, use it. If you need a new tenant, open Microsoft Entra admin center, Identity, Manage tenants, Create, Microsoft Entra ID, fill and create, then switch into it</li>
          <li>To open Cloud Shell, click the terminal icon at the top of the portal or go to https://shell.azure.com and choose PowerShell</li>
        </ol>
      </section>

      <section id="domain" class="space-y-4">
        <h2 class="text-xl font-semibold text-sky-700">3. Add and verify a custom domain</h2>
        <ol class="list-decimal list-inside space-y-2">
          <li>Entra admin center, Identity, Domain names, Add custom domain</li>
          <li>Enter your domain and Add</li>
          <li>Copy the TXT record values shown</li>
          <li>GoDaddy steps
            <ul class="list-disc list-inside pl-4">
              <li>Sign in at https://dcc.godaddy.com</li>
              <li>Domains, pick your domain, DNS</li>
              <li>Add record, Type TXT, Name @, Value MS=xxxxx, TTL 1 hour, Save</li>
              <li>For a subdomain, set Name to the label only, for example students</li>
            </ul>
          </li>
          <li>Back in Entra click Verify</li>
        </ol>
      </section>

      <section id="ri" class="space-y-6">
        <h2 class="text-xl font-semibold text-sky-700">4. RI setup</h2>
        <ol class="list-decimal list-inside space-y-2">
          <li>Open the RI guide and download Azure.json. https://help.rapididentity.com/docs/integrating-entraid-with-rapididentity-for-sso-using-graph</li>
          <li>In RI, Configuration, Security, Federated Partners, Import, pick Azure.json</li>
          <li>Open the partner and keep defaults. The template already includes SAML 1.1, Audience urn:federation:MicrosoftOnline, ReplyTo https://login.microsoftonline.com/login.srf, WS-Trust on</li>
          <li>Attribute mapping
            <ul class="list-disc list-inside pl-4">
              <li>Name Identifier = LDAP mail</li>
              <li>UPN = LDAP mail</li>
              <li>ImmutableID = LDAP idautoID</li>
            </ul>
          </li>
          <li>Get IdP endpoints and download the PEM from Configuration, Security, Identity Providers, open RapidIdentity</li>
        </ol>
      </section>

      <section id="federate" class="space-y-4">
        <h2 class="text-xl font-semibold text-sky-700">5. Federate the domain in Entra</h2>
        <p class="text-sm">Use Cloud Shell PowerShell. Paste your values or use Apply to prefill.</p>
        <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code id="ps-federate">Install-Module Microsoft.Graph -Scope CurrentUser -Force
Connect-MgGraph -TenantId TENANT_ID -UseDeviceCode -Scopes "Domain.ReadWrite.All","Directory.ReadWrite.All","Organization.ReadWrite.All","Directory.AccessAsUser.All"

$domain = "DOMAIN"
$riHost = "RI_HOST"
$cert   = @"
PEM_TEXT
"@ -replace "-+BEGIN CERTIFICATE-+|-+END CERTIFICATE-+|\r|\n",""

New-MgDomainFederationConfiguration -DomainId $domain `
  -DisplayName "RapidIdentity" `
  -IssuerUri "$riHost/idp" `
  -PassiveSignInUri "$riHost/idp/profile/wsfed" `
  -ActiveSignInUri "$riHost/idp/profile/wsfed" `
  -MetadataExchangeUri "$riHost/idp/profile/wstrust/mex" `
  -SignOutUri "$riHost/idp/logout" `
  -PreferredAuthenticationProtocol "wsFed" `
  -PromptLoginBehavior "nativeSupport" `
  -FederatedIdpMfaBehavior "acceptIfMfaDoneByFederatedIdp" `
  -SigningCertificate $cert

Get-MgDomain -DomainId $domain | fl Id,AuthenticationType</code></pre>
      </section>

      <section id="users" class="space-y-6">
        <h2 class="text-xl font-semibold text-sky-700">6. Pilot users</h2>
        <ol class="list-decimal list-inside space-y-2">
          <li>Create the user in RI with mail at your test domain. RI assigns idautoID automatically</li>
          <li>Create the user in Entra with the same anchor</li>
        </ol>
        <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code id="ps-user">Connect-MgGraph -TenantId TENANT_ID -UseDeviceCode -Scopes "User.ReadWrite.All","Directory.ReadWrite.All"

$upn   = "UPN"
$nick  = "NICK"
$pwd   = "PWD"
$anchor= "ANCHOR"

New-MgUser `
  -DisplayName $nick `
  -MailNickname $nick `
  -UserPrincipalName $upn `
  -AccountEnabled:$true `
  -PasswordProfile @{ password = $pwd; forceChangePasswordNextSignIn = $false } `
  -OnPremisesImmutableId $anchor</code></pre>
      </section>

      <section id="test" class="space-y-4">
        <h2 class="text-xl font-semibold text-sky-700">7. Test</h2>
        <ol class="list-decimal list-inside space-y-2">
          <li>Open this URL
            <div class="text-sm mt-1 bg-gray-100 rounded p-2"><code id="login-url">https://login.microsoftonline.com/login.srf?whr=DOMAIN</code></div>
          </li>
          <li>Sign in as your pilot user</li>
        </ol>
      </section>

      <section id="rollback" class="space-y-4 pb-16">
        <h2 class="text-xl font-semibold text-sky-700">8. Rollback</h2>
        <p class="text-sm">Return the test domain to managed auth by removing the federation config.</p>
        <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code id="ps-rollback">$domain = "DOMAIN"
$fed    = Get-MgDomainFederationConfiguration -DomainId $domain
Remove-MgDomainFederationConfiguration -DomainId $domain -InternalDomainFederationId $fed.Id
Get-MgDomain -DomainId $domain | fl Id,AuthenticationType</code></pre>
      </section>
    </main>

    <footer class="bg-sky-700 text-white text-sm py-4">
      <div class="max-w-7xl mx-auto px-4 text-center">Entra x RI Federation Sandbox</div>
    </footer>

    <script>
      const defaults = {
        TENANT_ID: "00000000-0000-0000-0000-000000000000",
        DOMAIN: "examplelab.com",
        RI_HOST: "https://your-ri-host",
        PEM: "-----BEGIN CERTIFICATE-----\nPASTE_PEM_HERE\n-----END CERTIFICATE-----",
        UPN: "testuser@examplelab.com",
        NICK: "testuser",
        PWD: "P@ssw0rd123!",
        ANCHOR: "aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee"
      };

      const ids = ["TENANT_ID","DOMAIN","RI_HOST","PEM","UPN","NICK","PWD","ANCHOR"];
      const els = Object.fromEntries(ids.map(id => [id, document.getElementById(id)]));

      const blockIds = ["ps-federate","ps-user","ps-rollback","login-url"];
      const blocks = Object.fromEntries(blockIds.map(id => [id, document.getElementById(id)]));

      blockIds.forEach(id => {
        const el = blocks[id];
        if (el) el.dataset.template = el.textContent;
      });

      ids.forEach(id => {
        if (els[id] && !els[id].value) els[id].value = defaults[id] || "";
      });

      function render() {
        const v = Object.fromEntries(ids.map(id => [id, (els[id]?.value || "").trim() || defaults[id]]));
        const map = new Map([
          ["TENANT_ID", v.TENANT_ID],
          ["DOMAIN", v.DOMAIN],
          ["RI_HOST", v.RI_HOST],
          ["PEM_TEXT", v.PEM],
          ["UPN", v.UPN],
          ["NICK", v.NICK],
          ["PWD", v.PWD],
          ["ANCHOR", v.ANCHOR]
        ]);
        blockIds.forEach(id => {
          const el = blocks[id];
          if (!el) return;
          let out = el.dataset.template || "";
          map.forEach((val, key) => { out = out.split(key).join(val); });
          el.textContent = out;
        });
      }

      function applyUserJson() {
        const raw = document.getElementById("RI_JSON").value.trim();
        if (!raw) return;
        try {
          const j = JSON.parse(raw);
          if (j.mail) els.UPN.value = j.mail;
          if (j.idautoID) els.ANCHOR.value = j.idautoID;
          if (!els.NICK.value && j.mail) els.NICK.value = j.mail.split("@")[0];
        } catch(e) { alert("Invalid JSON"); }
      }

      document.getElementById("applyVars").addEventListener("click", render);
      document.getElementById("applyUser").addEventListener("click", () => { applyUserJson(); render(); });

      const tabVars = document.getElementById("tab-vars");
      const tabUser = document.getElementById("tab-user");
      const panelVars = document.getElementById("panel-vars");
      const panelUser = document.getElementById("panel-user");

      tabVars.addEventListener("click", () => {
        tabVars.classList.add("text-sky-700","border-b-2","border-sky-700");
        tabUser.classList.remove("text-sky-700","border-b-2","border-sky-700");
        panelVars.classList.remove("hidden");
        panelUser.classList.add("hidden");
      });
      tabUser.addEventListener("click", () => {
        tabUser.classList.add("text-sky-700","border-b-2","border-sky-700");
        tabVars.classList.remove("text-sky-700","border-b-2","border-sky-700");
        panelUser.classList.remove("hidden");
        panelVars.classList.add("hidden");
      });

      render();
    </script>
  </body>
</html>
