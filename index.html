<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>RI x Entra Federation Sandbox Quick Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-50 text-gray-800 antialiased">
    <header class="bg-sky-700 text-white shadow">
      <div class="max-w-7xl mx-auto flex items-center justify-between px-4 py-6">
        <h1 class="text-2xl font-semibold tracking-wide">RI x Entra Federation Sandbox</h1>
        <nav class="hidden md:flex space-x-6 text-sm font-medium">
          <a href="#overview" class="hover:underline">Overview</a>
          <a href="#reqs" class="hover:underline">Requirements</a>
          <a href="#tenant" class="hover:underline">Azure Tenant</a>
          <a href="#domain" class="hover:underline">Custom Domain</a>
          <a href="#ri" class="hover:underline">RI Setup</a>
          <a href="#federate" class="hover:underline">Federate</a>
          <a href="#users" class="hover:underline">Pilot Users</a>
          <a href="#test" class="hover:underline">Test</a>
          <a href="#troubleshoot" class="hover:underline">Troubleshooting</a>
          <a href="#rollback" class="hover:underline">Rollback</a>
        </nav>
      </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-12 space-y-20">

      <section id="overview" class="space-y-4">
        <h2 class="text-xl font-semibold text-sky-700">0. Overview</h2>
        <p>This is a reference for me and any coworker who needs a fast Entra sandbox wired to RI. Use the RI doc template, change only what is needed for the tenant, and keep it simple. We use idautoID as the SourceAnchor. Create users in RI first, then create them in Entra with the same anchor.</p>
        <p>UI paths in RI:</p>
        <ul class="list-disc list-inside">
          <li>Identity Provider config: Configuration > Security > Identity Providers</li>
          <li>Federated Partners: Configuration > Security > Federated Partners</li>
        </ul>
        <div class="mt-3 rounded border-l-4 border-amber-400 bg-amber-50 p-3 text-sm">
          You may need a cheap test domain. GoDaddy often costs a few dollars per year. Do not federate the onmicrosoft domain.
        </div>
      </section>

      <section id="reqs" class="space-y-4">
        <h2 class="text-xl font-semibold text-sky-700">1. Requirements</h2>
        <ul class="list-disc list-inside space-y-1">
          <li>RI admin access</li>
          <li>Microsoft account for Azure portal</li>
          <li>Custom domain with DNS control</li>
          <li>Azure Cloud Shell access</li>
        </ul>
      </section>

      <section id="tenant" class="space-y-4">
        <h2 class="text-xl font-semibold text-sky-700">2. Create an Azure tenant</h2>
        <ol class="list-decimal list-inside space-y-2">
          <li>Go to https://portal.azure.com and sign in</li>
          <li>Open Microsoft Entra admin center and confirm you have a directory</li>
          <li>Note the Tenant ID and primary domain</li>
        </ol>
      </section>

      <section id="domain" class="space-y-4">
        <h2 class="text-xl font-semibold text-sky-700">3. Add and verify a custom domain</h2>
        <ol class="list-decimal list-inside space-y-2">
          <li>Entra admin center > Identity > Domain names > Add custom domain</li>
          <li>Add your test domain</li>
          <li>Create the TXT record at the registrar and Verify</li>
        </ol>
      </section>

      <section id="ri" class="space-y-6">
        <h2 class="text-xl font-semibold text-sky-700">4. RapidIdentity setup</h2>

        <div class="space-y-2">
          <h3 class="text-lg font-semibold">4.1 Get the RI template</h3>
          <p>Open the RI guide and download Azure.json. This partner works out of the box. You only adjust tenant specific values if needed.</p>
          <p><a class="text-sky-700 underline" target="_blank" rel="noopener" href="https://help.rapididentity.com/docs/integrating-entraid-with-rapididentity-for-sso-using-graph">RI guide</a></p>
        </div>

        <div class="space-y-2">
          <h3 class="text-lg font-semibold">4.2 Import and confirm defaults</h3>
          <ol class="list-decimal list-inside space-y-1">
            <li>Configuration > Security > Federated Partners</li>
            <li>Import Azure.json</li>
            <li>Open the partner and confirm it has SAML 1.1, Audience urn:federation:MicrosoftOnline, ReplyTo https://login.microsoftonline.com/login.srf, WS-Trust enabled</li>
          </ol>
          <p class="text-sm">I did not change those defaults. The only change in my lab was mapping ImmutableID to idautoID.</p>
        </div>

        <div class="space-y-2">
          <h3 class="text-lg font-semibold">4.3 Set attribute mapping for this flow</h3>
          <ul class="list-disc list-inside">
            <li>Name Identifier = LDAP mail</li>
            <li>UPN = LDAP mail</li>
            <li>ImmutableID = LDAP idautoID</li>
          </ul>
        </div>

        <div class="space-y-2">
          <h3 class="text-lg font-semibold">4.4 Get IdP endpoints and cert</h3>
          <ol class="list-decimal list-inside space-y-1">
            <li>Configuration > Security > Identity Providers > open the built in RI IdP</li>
            <li>Copy Entity ID, Passive and Active sign in URLs, MEX, and Logout</li>
            <li>Download the signing certificate in PEM format</li>
          </ol>
        </div>
      </section>

      <section id="federate" class="space-y-4">
        <h2 class="text-xl font-semibold text-sky-700">5. Federate the custom domain</h2>
        <ol class="list-decimal list-inside space-y-2">
          <li>Open Azure Cloud Shell and choose PowerShell</li>
          <li>Upload the IdP PEM you downloaded</li>
          <li>Run these commands with your values</li>
        </ol>
        <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>Install-Module Microsoft.Graph -Scope CurrentUser -Force
Connect-MgGraph -TenantId TENANT_GUID -UseDeviceCode -Scopes "Domain.ReadWrite.All","Directory.ReadWrite.All","Organization.ReadWrite.All","Directory.AccessAsUser.All"

$domain = "examplelab.com"
$riHost = "https://your-ri-host"
$cert   = (Get-Content -Raw "./ri-idp.pem") -replace "-+BEGIN CERTIFICATE-+|-+END CERTIFICATE-+|\r|\n",""

New-MgDomainFederationConfiguration -DomainId $domain `
  -DisplayName "RapidIdentity" `
  -IssuerUri "$riHost/idp" `
  -PassiveSignInUri "$riHost/idp/profile/wsfed" `
  -ActiveSignInUri "$riHost/idp/profile/wsfed" `
  -MetadataExchangeUri "$riHost/idp/profile/wstrust/mex" `
  -SignOutUri "$riHost/idp/logout" `
  -PreferredAuthenticationProtocol "wsFed" `
  -PromptLoginBehavior "nativeSupport" `
  -FederatedIdpMfaBehavior "acceptIfMfaDoneByFederatedIdp" `
  -SigningCertificate $cert

Get-MgDomain -DomainId $domain | fl Id,AuthenticationType</code></pre>
      </section>

      <section id="users" class="space-y-6">
        <h2 class="text-xl font-semibold text-sky-700">6. Create pilot users</h2>

        <div class="space-y-2">
          <h3 class="text-lg font-semibold">6.1 Create in RI first</h3>
          <p>Create a person record in RI. Example values:</p>
          <ul class="list-disc list-inside">
            <li>mail = testuser@examplelab.com</li>
            <li>idautoID = generated by RI. use this as ImmutableID</li>
          </ul>
        </div>

        <div class="space-y-2">
          <h3 class="text-lg font-semibold">6.2 Create in Entra with the same anchor</h3>
          <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>Connect-MgGraph -TenantId TENANT_GUID -UseDeviceCode -Scopes "User.ReadWrite.All","Directory.ReadWrite.All"

$upn   = "testuser@examplelab.com"
$nick  = "testuser"
$pwd   = "P@ssw0rd123!"
$anchor= "PUT_IDAUTOID_FROM_RI_HERE"

New-MgUser `
  -DisplayName $nick `
  -MailNickname $nick `
  -UserPrincipalName $upn `
  -AccountEnabled:$true `
  -PasswordProfile @{ password = $pwd; forceChangePasswordNextSignIn = $false } `
  -OnPremisesImmutableId $anchor</code></pre>
        </div>
      </section>

      <section id="test" class="space-y-4">
        <h2 class="text-xl font-semibold text-sky-700">7. Test</h2>
        <ol class="list-decimal list-inside space-y-2">
          <li>Open https://login.microsoftonline.com/login.srf?whr=examplelab.com</li>
          <li>Sign in as testuser@examplelab.com</li>
          <li>Expect redirect to RI then back to Microsoft</li>
        </ol>
      </section>

      <section id="troubleshoot" class="space-y-8">
        <h2 class="text-xl font-semibold text-sky-700">8. Troubleshooting</h2>
        <div class="grid md:grid-cols-2 gap-8">
          <div>
            <h3 class="font-semibold mb-2">Common errors</h3>
            <ul class="list-disc list-inside text-sm space-y-2">
              <li>AADSTS50008 SAML token invalid. Use the RI template and keep SAML 1.1, Audience urn:federation:MicrosoftOnline, ReplyTo https://login.microsoftonline.com/login.srf, NameID mail</li>
              <li>AADSTS51004 user account guid does not exist. You are sending a guid as NameID or the anchor does not match</li>
              <li>AADSTS90019 no tenant info. Add whr param during tests or fix NameID and ReplyTo</li>
              <li>Cannot update SourceAnchor. Delete and recreate the Entra user with the correct onPremisesImmutableId or un-federate in a lab only</li>
            </ul>
          </div>
          <div>
            <h3 class="font-semibold mb-2">Quick checks</h3>
            <pre class="bg-gray-100 p-3 rounded text-sm whitespace-pre-wrap"><code>Get-MgDomain -DomainId examplelab.com | fl Id,AuthenticationType
Get-MgDomainFederationConfiguration -DomainId examplelab.com | fl *
Invoke-MgGraphRequest -Method GET -Uri "https://graph.microsoft.com/v1.0/users/testuser@examplelab.com?$select=id,userPrincipalName,onPremisesImmutableId"</code></pre>
          </div>
        </div>
      </section>

      <section id="rollback" class="space-y-4 pb-16">
        <h2 class="text-xl font-semibold text-sky-700">9. Rollback</h2>
        <p class="text-sm">Un-federate the test domain if you want to return to managed auth.</p>
        <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>$domain = "examplelab.com"
$fed    = Get-MgDomainFederationConfiguration -DomainId $domain
Remove-MgDomainFederationConfiguration -DomainId $domain -InternalDomainFederationId $fed.Id
Get-MgDomain -DomainId $domain | fl Id,AuthenticationType</code></pre>
      </section>

    </main>

    <footer class="bg-sky-700 text-white text-sm py-4">
      <div class="max-w-7xl mx-auto px-4 text-center">
        RI x Entra Federation Sandbox
      </div>
    </footer>
  </body>
</html>
